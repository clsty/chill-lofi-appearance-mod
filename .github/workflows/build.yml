name: Build and Package ChillWithAnyone Mod

on:
  workflow_dispatch:
  push:
    #branches: [ main ]
    branches: [ test ]
    paths: [ .github/workflows/build.yml,src/**,build-resource/buildenv/** ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ChillWithAnyone
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Cache Unity assemblies
        id: cache-unity
        uses: actions/cache@v4
        with:
          path: build-resource/buildenv/mokgamedir/Chill With You_Data/Managed
          key: unity-assemblies-${{ hashFiles('build-resource/buildenv/download-unityengine.sh') }}
          restore-keys: |
            unity-assemblies-
      - name: Cache BepInEx
        id: cache-bepinex
        uses: actions/cache@v4
        with:
          path: build-resource/assets/BepInEx_win_x64
          key: bepinex-${{ hashFiles('build-resource/buildenv/download-bepinex.sh') }}
          restore-keys: |
            bepinex-
      - name: Download Unity assemblies from NuGet
        if: steps.cache-unity.outputs.cache-hit != 'true'
        run: build-resource/buildenv/download-unityengine.sh
      - name: Download BepInEx
        if: steps.cache-bepinex.outputs.cache-hit != 'true'
        run: build-resource/buildenv/download-bepinex.sh

      # Note: Assembly-CSharp.dll is game-specific and must be provided manually
      # It should be committed to build-resource/buildenv/mokgamedir/Chill With You_Data/Managed/
      # or provided through other means (GitHub Secrets, etc.)
      - name: Check for Assembly-CSharp.dll
        run: |
          if [ ! -f "build-resource/buildenv/mokgamedir/Chill With You_Data/Managed/Assembly-CSharp.dll" ]; then
            echo "警告: Assembly-CSharp.dll 未找到，构建可能失败"
            echo "请参考 build-resource/buildenv/README.md 了解如何提供此文件"
          fi

      - name: Build Cavi.ChillWithAnyone.dll
        run: |
          dotnet build src/Cavi.ChillWithAnyone.csproj -c Release /p:GamePath="${{ github.workspace }}/build-resource/buildenv/mokgamedir"
          cp src/bin/Release/netstandard2.1/Cavi.ChillWithAnyone.dll build-resource/assets/

      - name: Zip Artifact
        run: |
          cd build-resource/assets/
          zip -r ../../ChillWithAnyoneMod.zip .

      - name: Get commit info
        id: info
        run: |
          echo "hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "time=$(git log -1 --date=format-local:'%Y-%m-%d %H:%M:%S UTC' --format='%cd')" >> $GITHUB_OUTPUT
        env:
          TZ: UTC

      - name: Update Pre-Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: preview
          name: "Preview Build"
          body: |
            [![Build Status](https://github.com/${{ github.repository }}/actions/workflows/build.yml/badge.svg)](https://github.com/${{ github.repository }}/actions/workflows/build.yml)
            此为无固定版本号的预览版本，当有更新推送到特定目录时触发构建，也可由维护者手动触发构建。

            此构建的 Commit 信息：
            - HASH： ${{ steps.info.outputs.hash }}
            - 时间：${{ steps.info.outputs.time }}
          prerelease: true
          files: ChillWithAnyoneMod.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
