name: Pull Request Check Build

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ChillWithAnyone
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Cache APT packages
        uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: mono-complete zip

      - name: Cache Unity assemblies
        id: cache-unity
        uses: actions/cache@v4
        with:
          path: build-resource/buildenv/mokgamedir/Chill With You_Data/Managed
          key: unity-assemblies-${{ hashFiles('build-resource/buildenv/download-unityengine.sh') }}
          restore-keys: |
            unity-assemblies-
      - name: Cache BepInEx
        id: cache-bepinex
        uses: actions/cache@v4
        with:
          path: build-resource/assets/BepInEx_win_x64
          key: bepinex-${{ hashFiles('build-resource/buildenv/download-bepinex.sh') }}
          restore-keys: |
            bepinex-
      - name: Download Unity assemblies from NuGet
        if: steps.cache-unity.outputs.cache-hit != 'true'
        run: build-resource/buildenv/download-unityengine.sh
      - name: Download BepInEx
        if: steps.cache-bepinex.outputs.cache-hit != 'true'
        run: build-resource/buildenv/download-bepinex.sh

      # Note: Assembly-CSharp.dll is game-specific and must be provided manually
      - name: Check for Assembly-CSharp.dll
        run: |
          if [ ! -f "build-resource/buildenv/mokgamedir/Chill With You_Data/Managed/Assembly-CSharp.dll" ]; then
            echo "警告: Assembly-CSharp.dll 未找到，构建可能失败"
            echo "请参考 build-resource/buildenv/README.md 了解如何提供此文件"
          fi

      - name: Build Cavi.ChillWithAnyone.dll
        run: |
          make GAME_ROOT="${{ github.workspace }}/build-resource/buildenv/mokgamedir"
          cp src/bin/Release/netstandard2.1/Cavi.ChillWithAnyone.dll build-resource/assets/

      - name: Upload PR Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ChillWithAnyoneMod-PR-${{ github.event.pull_request.number }}
          path: build-resource/assets/
          retention-days: 5
